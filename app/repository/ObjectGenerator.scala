package repository

import java.io.PrintWriter

import api.dtos.DSLDTO

import scala.concurrent.{ ExecutionContext, Future }

class ObjectGenerator extends CodeGenerator {

  implicit val exec: ExecutionContext = ExecutionContext.global

  def generate(dsl: DSLDTO, outputPath: String, objectName: String): Future[String] = {

    val transformationsParser = dsl.transformations.map { transformation =>

      val lambda = transformation.predicate match {
        case Some(p) => "(" + p + ")"
        case None => ""
      }
      transformation.transformationName.transformationName + lambda
    }

    val res = transformationsParser.foldLeft("")(_ + "." + _)

    val inType = dsl.inType.`type`.getOrElse("")
    val outType = dsl.outType.`type`.getOrElse("")

    val fullPath = outputPath + "\\" + objectName + ".scala"

    Future(new PrintWriter(fullPath) {

      write("//This file is auto generated by code")
      write(
        s"""
         |
         |object $objectName{
         |def run(data:$inType): $outType = {
         |data$res
         |}
         |
         |def main(args: Array[String]): Unit = {
         |println(run _)
         |}
         |}
    """.stripMargin)
      close()
    })
    Future(fullPath)
  }
}

